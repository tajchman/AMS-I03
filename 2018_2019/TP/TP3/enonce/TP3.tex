\include{debut}

\begin{document}
%    \layout
    
    \begin{center}
    	\LARGE TP 3. Programmation multi-threads (2)
    \end{center}

	\section*{Préparation}
    
    Récupérer l'archive compressée {\tt TP3.tar.gz} et extraire les fichiers qui sont contenus dans cette archive:
    \begin{script}
        cd <repertoire dans votre espace de travail>
        cp /home/t/tajchman/AMSI03/2018-12-14/TP3.tar.gz .
        tar xvfz TP3.tar.gz
    \end{script}

    Se placer dans le répertoire {\tt TP3}:
    \begin{script}
        cd TP3
    \end{script}

    et préparer les compilations dans les points suivants avec les commandes ci-dessous:
    \begin{script}
        mkdir -p build
        cd build
        cmake ../src
        make install
        cd ..
    \end{script}
	

\section{Exemple OpenMP ``grain fin''}

Le fichier {\tt src/sinus\_fine/sinus.cxx} contient la version OpenMP ``grain fin'' obtenue à la fin du TP précédent.

On s'en servira de base pour les versions dites ``grain grossier''.

\begin{question}
	Comparer les temps d'exécution de la version séquentielle et de cette version en tapant les commandes
    \begin{script}
		./build/sinus\_seq/sinus\_seq 40000
		OMP\_NUM\_THREADS=3 ./build/sinus\_fine/sinus\_fine 40000
	\end{script}
\end{question}

\section{Exemple OpenMP ``grain grossier''}

Le fichier {\tt src/sinus\_coarse\_1/sinus.cxx} contient une version OpenMP ``grain grossier''.

\begin{question}
	Examiner ce fichier et comparez-le à la version ``grain fin''.
	
	Comparer les temps d'exécution de la version ``grain fin'' et de cette version en tapant les commandes
	\begin{script}
		OMP\_NUM\_THREADS=3 \textbackslash
		time -p ./build/sinus\_fine/sinus\_fine 40000
		OMP\_NUM\_THREADS=3 \textbackslash
		time -p ./build/sinus\_coarse\_1/sinus\_coarse\_1 40000
	\end{script}

	Il y a peu de différence (normalement) entre les deux versions. Expliquer pourquoi.
	
	Le code affiche aussi les temps de calcul des différents threads.
\end{question}

\section{Exemple OpenMP ``grain grossier'' avec équilibrage de charge}

Le calcul du sinus en utilisant un développement de Taylor a été volontairement ralenti pour accentuer la différence de temps calcul de $x \mapsto \sin x$ pour différentes valeurs de $x$.

Il s'en suit que les threads ne prennent pas le même temps de calcul suivant la plage des valeurs de $x$ qui leur sont attribuée (et qui est la même que dans le cas ``grain fin"), voir le fichier {\tt src/sin.cxx}.

Dans cette version, on utilise un algorithme d'équilibrage de charge entre les différents threads.

\begin{question}
	Examiner le fichier {\tt src/sinus\_coarse\_2/charge.cxx} qui contient cet algorithme et le fichier {\tt src/sinus\_coarse\_2/sinus.cxx} qui l'utilise.
	
	Exécuter plusieurs fois la commande
	\begin{script}
		OMP\_NUM\_THREADS=3 \textbackslash
		time ./build/sinus\_coarse\_2/sinus\_coarse\_2 40000
	\end{script}
	
	Chaque exécution tente d'améliorer les temps calcul en adaptant la répartition de charge de mieux en mieux (si possible).
\end{question}

\begin{remarque}
L'algorithme d'équilibrage de charge utilisé ici n'est pas optimal. Vous êtes encouragés à l'étudier et à l'améliorer.
\end{remarque}

\vfill\eject
\section{Parallélisation du (mini-)code avec le modèle OpenMP ``grain grossier''}

Le répertoire {code/PoissonOpenMP\_CoarseGrain} contient la version du code parallélisé par de l'OpenMP ``grain fin''.

\begin{question}
Remplacer la parallélisation ``grain fin'' par le modèle ``gros grain'' (sans perte de charge).

\textbf{Les fichiers source, que vous avez modifiés, seront à fournir avant la fin de la semaine suivante et vous seront renvoyés commentés et notés. La note obtenue pourra améliorer la note finale suivant les modalités précisées au premier cours.}
\end{question}

\section{Parallélisation en utilisant le concept de tâches OpenMP}

\begin{question}
Examiner le fichier {\tt src/exemple\_tasks/main\_seq.cxx}.

Cet exemple est difficile à paralléliser avec OpenMP. Expliquer pourquoi.
\end{question}

Le modèle de programmation par tâches OpenMP a été conçu pour répondre à ce type de situation.

\begin{question}
Examiner le fichier {\tt src/exemple\_tasks/main\_tasks.cxx}.

Compiler et exécuter. Comparer les temps calcul avec la version séquentielle.

Pensez à vérifier que les résultats sont bien les mêmes dans les deux cas.
\end{question}



\end{document}
